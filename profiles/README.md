# Profiles

This directory contains machine-specific configurations and reusable profile components. Profiles define the complete system setup for different machines (WSL, laptop, desktop) while shared components provide common functionality.

## Structure

```
profiles/
├── wsl/                    # WSL-specific profile
│   ├── default.nix        # Main WSL configuration
│   └── config.nix         # Feature flags and options
├── laptop/                 # Laptop profile
│   ├── default.nix        # Main laptop configuration
│   ├── config.nix         # Feature flags and options
│   └── hardware-configuration.nix  # Generated hardware config
├── desktop/                # Desktop profile
│   ├── default.nix        # Main desktop configuration
│   ├── config.nix         # Feature flags and options
│   ├── hardware-configuration.nix  # Generated hardware config
│   └── nvidia.nix         # NVIDIA-specific configuration
└── [shared components]     # Reusable configuration modules
    ├── base.nix           # Common base settings
    ├── boot.nix           # Boot loader configuration
    ├── sound.nix          # Audio configuration
    ├── i18n.nix           # Internationalization settings
    ├── network.nix        # Network configuration
    ├── firewall.nix       # Firewall settings
    └── smb.nix            # Samba/SMB configuration
```

## Profile Organization

Each profile directory follows a standard structure:

### `default.nix`
The main entry point for the profile. Imports all necessary components and defines system-specific packages and services.

**Common pattern**:
```nix
{ pkgs, username, ... }:
{
  imports = [
    ./hardware-configuration.nix  # Hardware-specific settings
    ./config.nix                  # Feature flags
    ../base.nix                   # Common base configuration
    # Additional shared components as needed
  ];

  # Profile-specific configuration
  environment.sessionVariables = {
    NIXHOST = "profile-name";
  };

  # Profile-specific packages and services
}
```

### `config.nix`
Defines which features are enabled for this profile using the module system's feature flags.

**Examples**:
```nix
# WSL profile - disable desktop and GUI
{
  gui.enable = false;
  desktop.enable = false;
}

# Desktop/Laptop - disable GNOME, use Hyprland
{
  nixos.desktop.gnome.enable = false;
}
```

### `hardware-configuration.nix`
Generated by `nixos-generate-config`, contains hardware-specific settings like:
- File system mounts
- Boot loader settings
- Kernel modules
- CPU microcode
- Swap configuration

**Note**: This file is machine-specific and should be regenerated for new installations.

## Available Profiles

### WSL (`wsl/`)

Configuration for Windows Subsystem for Linux.

**Key features**:
- WSL integration via NixOS-WSL
- Docker Desktop support
- Windows path integration
- CLI-only environment (no GUI/desktop)
- Custom automount and networking settings

**Environment variable**: `NIXHOST=NixOS-wsl`

**Usage**:
```bash
sudo nixos-rebuild switch --flake .#NixOS-wsl
```

### Laptop (`laptop/`)

Configuration for laptop machines.

**Key features**:
- Power management optimizations
- Battery management
- Hyprland desktop environment
- Hardware graphics acceleration
- Bluetooth support

**Environment variable**: `NIXHOST=laptop` (inferred from config if not set)

**Usage**:
```bash
sudo nixos-rebuild switch --flake .#laptop
```

### Desktop (`desktop/`)

Configuration for desktop machines with dedicated graphics.

**Key features**:
- NVIDIA GPU support
- Performance-oriented power settings
- Hyprland desktop environment
- NetworkManager with VPN plugins
- Hardware graphics acceleration
- Bluetooth support

**Environment variable**: `NIXHOST=desktop`

**Usage**:
```bash
sudo nixos-rebuild switch --flake .#desktop
```

## Shared Components

These are reusable configuration modules imported by profiles as needed.

### `base.nix`
Common baseline settings for all systems:
- 32-bit graphics support
- D-Bus broker implementation
- Hostname configuration
- Unfree package allowance
- Default timezone (Asia/Taipei)
- System state version

### `boot.nix`
Boot loader configuration:
- GRUB bootloader setup
- GRUB theme configuration
- Boot menu settings

### `sound.nix`
Audio system configuration:
- PipeWire audio server
- ALSA compatibility
- PulseAudio compatibility
- Low-latency settings

### `i18n.nix`
Internationalization settings:
- System locale configuration
- Input methods
- Timezone settings

### `network.nix`
Network configuration:
- Network manager settings
- Wireless configuration
- VPN support

### `firewall.nix`
Firewall rules and security settings.

### `smb.nix`
Samba/SMB file sharing configuration for Windows network compatibility.

## Creating a New Profile

To create a new profile for a different machine:

1. **Create the profile directory**:
   ```bash
   mkdir -p profiles/myprofile
   ```

2. **Generate hardware configuration**:
   ```bash
   nixos-generate-config --show-hardware-config > profiles/myprofile/hardware-configuration.nix
   ```

3. **Create `default.nix`**:
   ```nix
   { pkgs, username, ... }:
   {
     imports = [
       ./hardware-configuration.nix
       ./config.nix
       ../base.nix
       # Import other shared components as needed
       # ../boot.nix
       # ../sound.nix
       # ../i18n.nix
     ];

     environment.sessionVariables = {
       NIXHOST = "myprofile";
     };

     # Add profile-specific configuration here
   }
   ```

4. **Create `config.nix`**:
   ```nix
   { ... }:
   {
     # Set feature flags
     desktop.enable = true;
     gui.enable = true;
     cli.enable = true;
     general.enable = true;

     # Disable specific components if needed
     nixos.desktop.gnome.enable = false;
   }
   ```

5. **Add to flake.nix**:
   ```nix
   nixosConfigurations = {
     myprofile = helpers.mkSystem {
       system = "x86_64-linux";
       inherit username hostname;
       profile = "myprofile";
     };
   };
   ```

6. **Build and test**:
   ```bash
   sudo nixos-rebuild switch --flake .#myprofile
   ```

## Feature Flags

Profiles can control which parts of the system are enabled using these top-level flags:

- `cli.enable` - CLI tools and terminal configuration
- `gui.enable` - GUI applications
- `general.enable` - General system settings
- `desktop.enable` - Desktop environment
- `nixos.desktop.gnome.enable` - GNOME desktop (within desktop)
- `nixos.desktop.hyprland.enable` - Hyprland window manager (within desktop)

See `modules/options.nix` and module-specific options files for the complete hierarchy.

## Best Practices

1. **Keep profiles minimal**: Let the module system handle most configuration
2. **Use shared components**: Don't duplicate configuration across profiles
3. **Document hardware-specific settings**: Explain why certain hardware options are needed
4. **Set environment variables**: Always set `NIXHOST` to identify the active profile
5. **Version control hardware config**: Commit `hardware-configuration.nix` for reproducibility
6. **Test before committing**: Always run `sudo nixos-rebuild dry-build` first

## Profile Selection

Profiles are selected when rebuilding the system:

```bash
# Explicitly specify profile
sudo nixos-rebuild switch --flake .#<profile-name>

# Or use the 'just' command (uses NIXHOST environment variable)
just build
```

The active profile is determined by the flake output name after the `#`.
